<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="rt95"><meta name="description" content="record_of_mylife"><link rel="alternative" href="/atom.xml" title="你好我是王日天@" type="application/atom+xml"><link rel="icon" href="/img/favicon.png"><title>ntfs 文件系统中的供选数据流 - 你好我是王日天@</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script></head><body style="opacity:0"><header class="head"><h1 class="head-title u-fl"><a href="/">你好我是王日天@</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">目录</a></li><li class="head-nav__item"><a class="head-nav__link" href="/links">links</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time class="post__time" datetime="2019-08-16T16:00:00.000Z">2019 - 08 - 17</time><h1 class="post__title"><a href="/2019/08/17/ntfs系统中的ADS供选数据流/">ntfs 文件系统中的供选数据流</a></h1><div class="post__main echo"><h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1@ 前言"></a>1@ 前言</h2><p>前几天在审计 seacms 的时候碰到了一个问题十分有趣。上图说话：</p>
<p> <img src="https://raw.githubusercontent.com/59lx/userful_photo/master/myblog_photos/ntfs%E7%B3%BB%E7%BB%9F/1.png" alt="1.png"></p>
<p> <img src="https://raw.githubusercontent.com/59lx/userful_photo/master/myblog_photos/ntfs%E7%B3%BB%E7%BB%9F/2.png" alt="2.png"></p>
<p>上两图反映的问题就是在 windows 系统中，一个文件名中存在 <code>:</code> 的文件，在文件夹是看不到冒号后面完整的文件名的，但是这个文件的的确确存在，而且文件内容也可以成功的写入，亦或是读取。</p>
<p>在思索无果后，上小密圈提问得到了 wonderkun 师傅的指点，在 ll 的指引下，学习了一下ntfs 下的供选数据流，在此做笔记，也供有相同疑惑的小伙伴们参阅。</p>
<h2 id="2-ADS-供选数据流"><a href="#2-ADS-供选数据流" class="headerlink" title="2@ ADS 供选数据流"></a>2@ ADS 供选数据流</h2><h3 id="2-1-MFT-主文件表"><a href="#2-1-MFT-主文件表" class="headerlink" title="2.1 MFT 主文件表"></a>2.1 MFT 主文件表</h3><p>ntfs 文件系统使用 Master File Table（MFT）即主文件表来管理文件。下面是百度百科对于 MFT 的简略介绍：</p>
<blockquote>
<p>MFT，即主文件表（Master File Table）的简称，它是NTFS文件系统的核心。MFT由一个个MFT项（也称为文件记录）组成，每个MFT项占用1024字节的空间。每个MFT项的前部几十个字节有着固定的头结构，用来描述本MFT项的相关信息。后面的字节存放着“属性”。每个文件和目录的信息都包含在MFT中，每个文件和目录至少有一个MFT项。除了引导扇区外，访问其他任何一个文件前都需要先访问MFT，在MFT中找到该文件的MFT项，根据MFT项中记录的信息找到文件内容并对其进行访问。NTFS(New Technology File System)，是一种新型文件系统。</p>
</blockquote>
<p>windows 的每个文件都对应一个 MFT 记录，每个记录由诸多属性组成。譬如我们现在有一个叫做 test.txt 的文件，内容为 <strong>Hello,world!</strong> , 那么它的 MFT 结构如下图：</p>
<p> <img src="https://raw.githubusercontent.com/59lx/userful_photo/master/myblog_photos/ntfs%E7%B3%BB%E7%BB%9F/3.jpg" alt="3.jpg"></p>
<p>我们通过这个实例来学习下 MFT 的属性。</p>
<ul>
<li>$FILE_NAME 属性包含文件名，创建，修改，访问的时间。这里的文件名为 test.txt</li>
<li>$DATA 包含文件具体内容。这要注意的是 ，此例文本内容偏小，小于1kb，所以直接存储在 MFT 这个结构里面了，称作 Resident（理解为本地居民）。如果文件内容大于1kb，该位置就会放置改文本内容的具体存储地址，类型也会变为 non-resident。</li>
</ul>
<h3 id="2-2-MFT-的多文件属性"><a href="#2-2-MFT-的多文件属性" class="headerlink" title="2.2 MFT 的多文件属性"></a>2.2 MFT 的多文件属性</h3><p>通过上面我们了解了 MFT 的大致结构，而它并不仅仅是具有一个 $DATA 属性的。一个文件可以有多个 $DATA 属性。这里为了方便查看，我们还是来看看引用文章上面的例子。当下我们向 test.txt 加入一个 ThisIsAnADS 的 $DATA属性:</p>
<p><code>echo Hello,freebuf! &gt; test.txt:ThisIsAnADS</code></p>
<p>其 MFT 结构就变成了下面这样：</p>
<p> <img src="https://raw.githubusercontent.com/59lx/userful_photo/master/myblog_photos/ntfs%E7%B3%BB%E7%BB%9F/4.jpg" alt="4.jpg"></p>
<p>这里可以看到多出来一个 $DATA 属性，而且还有名字，就是我们起的 ThisIsAnADS 。我们平常存储在文件里的都是称为主数据流(primary data stream)，默认没有名字。而之后创建的数据流就叫做供选数据流(alternate data stream),即 ADS，原文章作者说其翻译为<strong>供选数据流</strong>更合适，我也有同感。翻译为交换数据流并没有体现出交换两个字的过程。</p>
<p>通常意义下，ADS 对用户来说都是表层可视化隐藏的，譬如前言例子中的文件，打开是无内容的。</p>
<p> <img src="https://raw.githubusercontent.com/59lx/userful_photo/master/myblog_photos/ntfs%E7%B3%BB%E7%BB%9F/5.png" alt="5.png"></p>
<p>单单看大小确实如此。我们先略过占用空间不为0的这个现象。后面会讨论到。</p>
<p>下面，我们先来看看如何看到隐藏在供选数据流里面的数据。</p>
<h3 id="2-3-供选数据流的使用"><a href="#2-3-供选数据流的使用" class="headerlink" title="2.3 供选数据流的使用"></a>2.3 供选数据流的使用</h3><p>由于隐蔽性较强，这一技术被广泛的应用到了木马，后门文件的隐藏上面。我们不仅可以隐藏文本数据到 ads 中，还可以是图片数据，亦或是可执行的 exe 文件数据。方法相似：</p>
<h4 id="1-寄生在文件上"><a href="#1-寄生在文件上" class="headerlink" title="1# 寄生在文件上"></a>1# 寄生在文件上</h4><p>同上例，我们可以将图片隐藏进入另一个文件的供选数据流里面,此时使用到 type 命令，作用相似于 linux 下的cat 命令，具体用法<a href="https://blog.csdn.net/grey_csdn/article/details/69922844" target="_blank" rel="noopener">戳这</a>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type shell.png &gt;&gt; 1.txt:test.png</span><br></pre></td></tr></table></figure>

<p>我们将图片数据寄生在文件 1.txt 上面</p>
<h4 id="2-寄生在文件夹上"><a href="#2-寄生在文件夹上" class="headerlink" title="2# 寄生在文件夹上"></a>2# 寄生在文件夹上</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type shell.png &gt;&gt; test:test.png</span><br></pre></td></tr></table></figure>

<p>将图片数据寄生在文件夹 test 上。</p>
<h3 id="2-4-查看供选数据流"><a href="#2-4-查看供选数据流" class="headerlink" title="2.4 查看供选数据流"></a>2.4 查看供选数据流</h3><p>现在我们讲讲如何查看 ads 数据。</p>
<h4 id="1-系统自带应用查看"><a href="#1-系统自带应用查看" class="headerlink" title="1# 系统自带应用查看"></a>1# 系统自带应用查看</h4><ul>
<li><p>文本文件的话就用记事本 【notepad + 文件名】打开。</p>
</li>
<li><p>图片文件就是用画板 【mspaint + 文件名】打开。</p>
</li>
<li><p>可执行文件就用 【start + 文件名】 打开。</p>
</li>
</ul>
<p>这里需要注意的是，可能考虑到安全因素，微软在 windows_Xp 之后就禁止直接执行供选数据流中的可执行文件了，但是是存在绕过方法的，有兴趣的同学可以<a href="https://www.freebuf.com/articles/73270.html" target="_blank" rel="noopener">戳这</a>进去看看。</p>
<p>我们这里沿用上面的例子，打开寄生在文件夹下面的图片</p>
<p><code>mspaint test:test.png</code></p>
<p> <img src="https://raw.githubusercontent.com/59lx/userful_photo/master/myblog_photos/ntfs%E7%B3%BB%E7%BB%9F/6.png" alt="6.png"></p>
<h4 id="2-cmd-下使用-dir-r-命令查看"><a href="#2-cmd-下使用-dir-r-命令查看" class="headerlink" title="2# cmd 下使用 dir /r 命令查看"></a>2# cmd 下使用 dir /r 命令查看</h4><p>还是以上面图片为例，在文件存在的路径下面打开 cmd：</p>
<p><code>dir /r test:test.png</code></p>
<p> <img src="https://raw.githubusercontent.com/59lx/userful_photo/master/myblog_photos/ntfs%E7%B3%BB%E7%BB%9F/7.png" alt="7.png"></p>
<p>由于之前我测试的时候还添加了几次，所以查看 ads 数据流的时候还有其他文件。这也从侧面反映了一个问题，就是可以在一个文件或者文件下添加多个供选数据流，而且它们互不影响。</p>
<h4 id="3-powershell-下的-Get-Content-指令查看"><a href="#3-powershell-下的-Get-Content-指令查看" class="headerlink" title="3# powershell 下的 Get-Content 指令查看"></a>3# powershell 下的 Get-Content 指令查看</h4><p>指令格式</p>
<p><code>Get-Content [被寄生的文件/文件夹] -stream [ads数据流名]</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\rt95\Desktop\test&gt; <span class="built_in">Get-content</span> test <span class="literal">-stream</span> test.png</span><br></pre></td></tr></table></figure>

<p> <img src="https://raw.githubusercontent.com/59lx/userful_photo/master/myblog_photos/ntfs%E7%B3%BB%E7%BB%9F/8.png" alt="8.png"></p>
<p>可以看到，这条指令是直接可以读出数据内容的，用来读取寄生的 ads 文本数据会非常方便。</p>
<h2 id="3-几个问题"><a href="#3-几个问题" class="headerlink" title="3@ 几个问题"></a>3@ 几个问题</h2><h3 id="3-1-供选数据流的大小"><a href="#3-1-供选数据流的大小" class="headerlink" title="3.1 供选数据流的大小"></a>3.1 供选数据流的大小</h3><p>刚刚我们看到，存储的文件大小和占用空间不一致。证明供选数据流是会占用磁盘空间的。侧面反映出 windows 系统查看文件属性的时候，显示文件大小只是主数据流的大小，而占用空间则会较为真实的反映主数据和供选数据流的总大小。</p>
<h3 id="3-2-linux-下对-ads-的读取"><a href="#3-2-linux-下对-ads-的读取" class="headerlink" title="3.2  linux 下对 ads 的读取"></a>3.2  linux 下对 ads 的读取</h3><p>有时会出现在 linux 系统下读取 windows 文件的情况，这时我们需要挂载磁盘的读取方式，或者使用 ntfs-3g 程序进行 ntfs 文件系统的文件读写。</p>
<blockquote>
<p>NTFS-3G 是一个由 <a href="http://zh.wikipedia.org/wiki/Tuxera" target="_blank" rel="noopener">Tuxera</a> 公司开发并维护的开源项目。目的是为 Linux 提供 NTFS 分区的的驱动程序。可以安全高速的对 Windows NT （包含 Windows 2000、Windows XP、Windows Server 2003 和 Windows Vista）的文件系统进行读写。</p>
</blockquote>
<p>可以使用 apt 或者 yum 下载 ntfs-3g。</p>
<p>然后我们创建一个 含有 ads 的文本文件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">touch 1.txt</span><br><span class="line">echo hello,rt95 &gt; 1.txt:2.txt</span><br><span class="line">cat 1.txt:2.txt</span><br></pre></td></tr></table></figure>

<p>可以看到文件内容被显示。</p>
<p> <img src="https://raw.githubusercontent.com/59lx/userful_photo/master/myblog_photos/ntfs%E7%B3%BB%E7%BB%9F/9.png" alt="9.png"></p>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4@ 总结"></a>4@ 总结</h2><p>实习结束了，学到了不少东西，有感知上的，有知识上的。希望剩下的大学时光能不辜负自己的一腔热血吧~</p>
<p>加油 :)</p>
<p>Reference:</p>
<p><code>https://baike.baidu.com/item/MFT/1185355?fr=aladdin</code></p>
<p><code>https://www.freebuf.com/articles/73270.html</code></p>
<p><code>http://www.huike007.cn/?p=150</code></p>
<p><code>https://blog.csdn.net/alone_map/article/details/51851071</code></p>
<p><code>https://www.qingsword.com/qing/812.html</code></p>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/ntfs/">ntfs</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/方法/">方法</a></li></ul></footer></article><section class="reward"><a class="btn-reward" href="#">打赏</a><div class="reward-wrapper clearfix"><img src="/img/wechat.png" title="微信"></div></section><div class="comments" id="v-container"><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="/js/Valine.min.js"></script><script>new Valine({
  av: AV,
  el: '#v-container',
  app_id: 'i6h8x11R8G9rRGJ0kHtxXf1P-gzGzoHsz',
  app_key: 'Tbq1MIb9WkFtwLmiX9RwAKqJ',
  avatar: 'retro',
  avatarForce: false,
  notify: false,
  verify: false,
  lang: 'zh-cn',
  placeholder: 'balabala~',
  pageSize: 20,
  visitor: true,
  highlight: true,
  emoticon_url: '/img/alu',
  emoticon_list: ["吐.png","喷血.png","狂汗.png","不说话.png","汗.png","坐等.png","献花.png","不高兴.png","中刀.png","害羞.png","皱眉.png","小眼睛.png","中指.png","尴尬.png","瞅你.png","想一想.png","中枪.png","得意.png","肿包.png","扇耳光.png","亲亲.png","惊喜.png","脸红.png","无所谓.png","便便.png","愤怒.png","蜡烛.png","献黄瓜.png","内伤.png","投降.png","观察.png","看不见.png","击掌.png","抠鼻.png","邪恶.png","看热闹.png","口水.png","抽烟.png","锁眉.png","装大款.png","吐舌.png","无奈.png","长草.png","赞一个.png","呲牙.png","无语.png","阴暗.png","不出所料.png","咽气.png","期待.png","高兴.png","吐血倒地.png","哭泣.png","欢呼.png","黑线.png","喜极而泣.png","喷水.png","深思.png","鼓掌.png","暗地观察.png"],
});</script></div></main><footer class="foot"><div class="foot-copy">&copy; 2018 - 2020 rt95</div></footer><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>